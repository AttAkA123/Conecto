<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Connecto ‚Äî –ü—Ä–æ—Ñ–∏–ª—å –∏ –ù–æ–≤–æ—Å—Ç–∏</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
  html,body{height:100%}
  body{background:#0b0b1f;color:#fff;height:100vh;overflow:hidden;background-image:radial-gradient(#1a1a2e 1px, transparent 1px), radial-gradient(#1a1a2e 1px, transparent 1px);background-size:50px 50px;background-position:0 0,25px 25px}

  /* layout */
  .container{display:flex;height:100vh;width:100vw}
  .sidebar{width:240px;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);padding:20px;display:flex;flex-direction:column;gap:14px;flex-shrink:0;border-right:1px solid rgba(255,255,255,0.05)}
  .center{flex:1;display:flex;flex-direction:column;min-width:0;}
  .main{flex:1;background:rgba(10,10,30,0.7);backdrop-filter:blur(10px);margin:20px;border-radius:18px;padding:22px;position:relative;overflow:auto;transition:margin-right .18s ease}
  .chat-panel{width:0;overflow:hidden;transition:width .2s ease;border-left:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;background:rgba(5,5,20,0.8)}
  .chat-panel.open{width:380px}

  .menu-item{padding:12px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:0.15s;color:#b0b0ff}
  .menu-item:hover{background:rgba(255,255,255,0.08);color:#fff}
  .notif-count{background:#ff4d4d;border-radius:50%;padding:2px 8px;font-size:12px}
  .hidden{display:none}
  input,textarea,button{padding:10px;margin:6px 0;border-radius:10px;border:none;outline:none;font-family:inherit}
  input,textarea{width:100%;background:rgba(255,255,255,0.08);color:#fff}
  textarea{min-height:80px;resize:vertical;word-wrap:break-word;overflow-wrap:break-word}
  button{cursor:pointer;background:linear-gradient(90deg,#4a4aff,#8b5cf6);color:#fff;transition:0.2s}
  button:hover{opacity:0.95}
  .card{background:rgba(0,0,40,0.5);backdrop-filter:blur(6px);border-radius:12px;padding:12px;margin-bottom:12px;word-break:break-word}
  .card .row{display:flex;align-items:center;justify-content:space-between}
  .card .info{display:flex;align-items:center;gap:10px}
  .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,0.1)}
  .like-btn{padding:6px 10px;border-radius:8px;border:none;background:transparent}
  .like-btn.liked{background:rgba(255,255,255,0.2)}
  .post-create{margin-bottom:14px}
  .btn-primary{background:linear-gradient(90deg,#6ea8fe,#8b5cf6);color:#fff}
  .small-muted{font-size:13px;color:rgba(255,255,255,0.6)}
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .search{width:260px}
  .flex{display:flex;gap:10px;align-items:center}

  /* chat styles (right panel) */
  .chat-header{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid rgba(255,255,255,0.03);background:rgba(10,10,40,0.5)}
  .chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
  .msg-self{align-self:flex-end;background:rgba(100,100,255,0.9);color:#fff;padding:10px;border-radius:12px;max-width:78%;word-break:break-word}
  .msg-other{align-self:flex-start;background:rgba(50,50,100,0.6);padding:10px;border-radius:12px;max-width:78%;word-break:break-word}
  .chat-input{display:flex;padding:12px;border-top:1px solid rgba(255,255,255,0.03);gap:8px}
  .chat-input input{flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,0.05);color:#fff}
  .chat-input button{padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,#4a4aff,#8b5cf6);border:none;color:#fff;cursor:pointer}

  /* dialogs list */
  .dialogs-list{display:flex;flex-direction:column;gap:8px}
  .dialog-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(50,50,100,0.4);cursor:pointer}
  .dialog-item:hover{background:rgba(80,80,150,0.6)}
  .unread-badge{background:#ff4747;border-radius:12px;padding:3px 8px;font-size:12px;color:#fff}

  .main.with-chat{margin-right:400px}
</style>
</head>
<body>
<div class="container">
  <!-- LEFT SIDEBAR -->
  <div class="sidebar">
    <div class="menu-item" id="profileTab">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="menu-item" id="addFriendTab">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</div>
    <div class="menu-item" id="friendsTab">üë• –î—Ä—É–∑—å—è</div>
    <div class="menu-item" id="messagesTab">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è <span id="msgCount" class="notif-count">0</span></div>
    <div class="menu-item" id="newsTab">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
    <div class="menu-item" id="notificationsTab">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è <span id="notifCount" class="notif-count">0</span></div>
    <button id="logoutBtn">–í—ã–π—Ç–∏</button>
  </div>

  <!-- CENTER (main content) -->
  <div class="center">
    <div class="main" id="mainArea">
      <div class="topbar">
        <div class="flex">
          <img id="profileAvatarSmall" src="https://via.placeholder.com/48" class="avatar">
          <div>
            <div id="profileName">–ò–º—è</div>
            <div id="profileStatus" class="small-muted">–°—Ç–∞—Ç—É—Å: –ù–µ –æ–Ω–ª–∞–π–Ω</div>
          </div>
        </div>
        <div class="flex">
          <input id="searchInput" class="search" placeholder="–ü–æ–∏—Å–∫...">
          <button id="newPostQuick">–ù–∞–ø–∏—Å–∞—Ç—å</button>
        </div>
      </div>

      <!-- panels -->
      <div id="profilePanel">
        <div style="display:flex;gap:16px;align-items:center;margin-bottom:12px">
          <img id="profileAvatar" src="https://via.placeholder.com/100" style="width:100px;height:100px;border-radius:50%">
          <div>
            <h2 id="profileNameBig">–ò–º—è</h2>
            <p>ID: <span id="profileID">000000</span></p>
            <p>–°—Ç–∞—Ç—É—Å: <span id="profileStatusBig">–ù–µ –æ–Ω–ª–∞–π–Ω</span></p>
            <button id="settingsBtn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          </div>
        </div>
      </div>

      <div id="settingsPanel" class="hidden card">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
        <input type="text" id="newName" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
        <input type="text" id="newAvatar" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä">
        <input type="text" id="newStatus" placeholder="–°—Ç–∞—Ç—É—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: –û–Ω–ª–∞–π–Ω)">
        <button id="saveSettings" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <div id="addFriendPanel" class="hidden card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</h3>
        <input type="number" id="friendID" placeholder="–í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID">
        <button id="searchFriend">–ü–æ–∏—Å–∫</button>
        <div id="friendResult"></div>
      </div>

      <div id="friendsPanel" class="hidden"></div>

      <div id="messagesPanel" class="hidden card">
        <h3>–ß–∞—Ç—ã</h3>
        <div id="chatsList" class="dialogs-list"></div>
      </div>

      <div id="newsPanel" class="hidden">
        <div class="post-create card">
          <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>
          <textarea id="postText" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"></textarea>
          <button id="createPostBtn" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div id="postsFeed"></div>
      </div>

      <div id="notificationsPanel" class="hidden card"></div>
    </div>
  </div>

  <!-- RIGHT CHAT PANEL -->
  <div id="chatPanel" class="chat-panel">
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDW9wSQ8xVTvrgaDzwYrg1v8Jzm5KqrrAU",
  authDomain: "baseuser-82b5d.firebaseapp.com",
  projectId: "baseuser-82b5d",
  storageBucket: "baseuser-82b5d.appspot.com",
  messagingSenderId: "307488509181",
  appId: "1:307488509181:web:50397c7ba445c6e45a8294"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const profileTab = document.getElementById('profileTab');
const addFriendTab = document.getElementById('addFriendTab');
const friendsTab = document.getElementById('friendsTab');
const messagesTab = document.getElementById('messagesTab');
const newsTab = document.getElementById('newsTab');
const notificationsTab = document.getElementById('notificationsTab');
const notifCount = document.getElementById('notifCount');
const msgCount = document.getElementById('msgCount');

const profilePanel = document.getElementById('profilePanel');
const settingsPanel = document.getElementById('settingsPanel');
const addFriendPanel = document.getElementById('addFriendPanel');
const friendsPanel = document.getElementById('friendsPanel');
const messagesPanel = document.getElementById('messagesPanel');
const newsPanel = document.getElementById('newsPanel');
const notificationsPanel = document.getElementById('notificationsPanel');

const profileName = document.getElementById('profileName');
const profileNameBig = document.getElementById('profileNameBig');
const profileID = document.getElementById('profileID');
const profileStatus = document.getElementById('profileStatus');
const profileStatusBig = document.getElementById('profileStatusBig');
const profileAvatar = document.getElementById('profileAvatar');
const profileAvatarSmall = document.getElementById('profileAvatarSmall');

const logoutBtn = document.getElementById('logoutBtn');
const friendIDInput = document.getElementById('friendID');
const searchFriendBtn = document.getElementById('searchFriend');
const friendResult = document.getElementById('friendResult');

const createPostBtn = document.getElementById('createPostBtn');
const postText = document.getElementById('postText');
const postsFeed = document.getElementById('postsFeed');

const chatsList = document.getElementById('chatsList');

const chatPanel = document.getElementById('chatPanel');
const mainArea = document.getElementById('mainArea');

let currentChatID = null;
let currentFriendUID = null;
let currentUser = null;

function hideAllPanels(){
  profilePanel.classList.add('hidden');
  settingsPanel.classList.add('hidden');
  addFriendPanel.classList.add('hidden');
  friendsPanel.classList.add('hidden');
  messagesPanel.classList.add('hidden');
  newsPanel.classList.add('hidden');
  notificationsPanel.classList.add('hidden');
}

function escapeHtml(str){
  if(!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

profileTab.addEventListener('click', ()=>{ hideAllPanels(); profilePanel.classList.remove('hidden'); });
addFriendTab.addEventListener('click', ()=>{ hideAllPanels(); addFriendPanel.classList.remove('hidden'); });
friendsTab.addEventListener('click', ()=>{ hideAllPanels(); friendsPanel.classList.remove('hidden'); updateFriendsList(); });
messagesTab.addEventListener('click', ()=>{ hideAllPanels(); messagesPanel.classList.remove('hidden'); updateMessagesList(); });
newsTab.addEventListener('click', ()=>{ hideAllPanels(); newsPanel.classList.remove('hidden'); });
notificationsTab.addEventListener('click', ()=>{ hideAllPanels(); notificationsPanel.classList.remove('hidden'); updateNotifications(); });

async function loadProfile(){
  const user = auth.currentUser;
  if(!user) return;
  currentUser = user;
  const doc = await db.collection('users').doc(user.uid).get();
  if(!doc.exists) {
    await db.collection('users').doc(user.uid).set({
      name: user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
      customID: Math.floor(100000 + Math.random()*899999),
      avatar: user.photoURL || null,
      status: '–û–Ω–ª–∞–π–Ω',
      friends: []
    }, {merge:true});
    return loadProfile();
  }
  const data = doc.data();
  profileName.textContent = data.name || user.displayName || '–ò–º—è';
  profileNameBig.textContent = data.name || user.displayName || '–ò–º—è';
  profileID.textContent = data.customID || '000000';
  profileStatus.textContent = data.status || '–ù–µ –æ–Ω–ª–∞–π–Ω';
  profileStatusBig.textContent = data.status || '–ù–µ –æ–Ω–ª–∞–π–Ω';
  profileAvatar.src = data.avatar || 'https://via.placeholder.com/100';
  profileAvatarSmall.src = data.avatar || 'https://via.placeholder.com/48';
}

auth.onAuthStateChanged(async (user)=>{
  if(!user){ window.location.href = 'index.html'; return; }
  currentUser = user;
  await loadProfile();
  listenForPosts();
  listenForMessageCounts();
  updateMessagesList();
  hideAllPanels();
  profilePanel.classList.remove('hidden');
});

logoutBtn.onclick = ()=>{ auth.signOut().then(()=>{ window.location.href='index.html'; }); }

const settingsBtn = document.getElementById('settingsBtn');
const newName = document.getElementById('newName');
const newAvatar = document.getElementById('newAvatar');
const newStatus = document.getElementById('newStatus');
const saveSettings = document.getElementById('saveSettings');

settingsBtn.onclick = ()=>{ hideAllPanels(); settingsPanel.classList.remove('hidden'); };
saveSettings.onclick = async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  let updates = {};
  if(newName.value.trim()) updates.name = newName.value.trim();
  if(newAvatar.value.trim()) updates.avatar = newAvatar.value.trim();
  if(newStatus.value.trim()) updates.status = newStatus.value.trim();
  if(Object.keys(updates).length===0) return alert('–ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å');
  await db.collection('users').doc(user.uid).update(updates);
  await loadProfile();
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
};

searchFriendBtn.onclick = async ()=>{
  const id = Number(friendIDInput.value.trim());
  if(!id) return;
  const q = await db.collection('users').where('customID','==',id).get();
  if(q.empty){ friendResult.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</p>'; return; }
  const friendDoc = q.docs[0];
  const friendData = friendDoc.data();
  friendResult.innerHTML = `<p>${friendData.name} (ID:${friendData.customID})</p><button id="sendRequest">–î–æ–±–∞–≤–∏—Ç—å</button>`;
  document.getElementById('sendRequest').onclick = async ()=>{
    const user = auth.currentUser;
    await db.collection('users').doc(friendDoc.id).collection('notifications').add({
      type:'friend_request', fromUID:user.uid, fromName: user.displayName || user.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', timestamp: firebase.firestore.FieldValue.serverTimestamp(), status:'pending'
    });
    friendResult.innerHTML = '<p>–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</p>';
    updateNotifications();
  };
};

async function updateFriendsList(){
  const user = auth.currentUser;
  const doc = await db.collection('users').doc(user.uid).get();
  const friendsUIDs = (doc.exists && doc.data().friends) ? doc.data().friends : [];
  friendsPanel.innerHTML = '<h3>–î—Ä—É–∑—å—è</h3>';
  if(!friendsUIDs.length){ friendsPanel.innerHTML += '<p>–£ –≤–∞—Å –Ω–µ—Ç –¥—Ä—É–∑–µ–π</p>'; return; }
  for(let uid of friendsUIDs){
    const fDoc = await db.collection('users').doc(uid).get();
    if(!fDoc.exists) continue;
    const fData = fDoc.data();
    const div = document.createElement('div');
    div.className='card flex';
    div.innerHTML = `
      <div class="flex" style="align-items:center;gap:10px">
        <img src="${fData.avatar || 'https://via.placeholder.com/48'}" class="avatar">
        <strong>${escapeHtml(fData.name)}</strong>
      </div>
      <button class="btn-primary">–ù–∞–ø–∏—Å–∞—Ç—å</button>
    `;
    div.querySelector('button').onclick=()=>{ openChat(uid,fData.name) };
    friendsPanel.appendChild(div);
  }
}

/* ===== POSTS ====== */
createPostBtn.onclick = async ()=>{
  const text = postText.value.trim();
  if(!text) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
  const userDoc = await db.collection('users').doc(currentUser.uid).get();
  const u = userDoc.data();
  await db.collection('posts').add({
    authorUID: currentUser.uid,
    authorName: u.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
    authorAvatar: u.avatar || null,
    text:text,
    likes:[],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  postText.value='';
};

function listenForPosts(){
  db.collection('posts').orderBy('timestamp','desc').onSnapshot(snapshot=>{
    postsFeed.innerHTML='';
    snapshot.forEach(doc=>{
      const p = doc.data();
      const card = document.createElement('div'); card.className='card';
      const liked = (p.likes||[]).includes(currentUser.uid);
      card.innerHTML = `
        <div class="row">
          <div class="info"><img src="${p.authorAvatar||'https://via.placeholder.com/48'}" class="avatar"><div><strong>${p.authorName}</strong><div class="small-muted">${p.timestamp? new Date(p.timestamp.toDate()).toLocaleString() : ''}</div></div></div>
          <div class="flex"><button class="like-btn ${liked?'liked':''}" data-id="${doc.id}">‚ù§Ô∏è ${(p.likes||[]).length}</button></div>
        </div>
        <div style="margin-top:8px">${escapeHtml(p.text)}</div>
      `;
      postsFeed.appendChild(card);
      card.querySelector('.like-btn').onclick=async ()=>{
        const uid = currentUser.uid;
        const ref = db.collection('posts').doc(doc.id);
        await db.runTransaction(async tx=>{
          const snap = await tx.get(ref);
          const likes = snap.data().likes||[];
          if(likes.includes(uid)) tx.update(ref,{likes:firebase.firestore.FieldValue.arrayRemove(uid)});
          else tx.update(ref,{likes:firebase.firestore.FieldValue.arrayUnion(uid)});
        });
      };
    });
  });
}

/* ===== CHAT ===== */
function openChat(friendUID, friendName){
  currentFriendUID=friendUID;
  currentChatID=[currentUser.uid,friendUID].sort().join('_');
  const chatRef = db.collection('chats').doc(currentChatID);
  chatRef.get().then(async chatDoc=>{
    if(!chatDoc.exists){
      await chatRef.set({members:[currentUser.uid,friendUID],unreadCounts:{[currentUser.uid]:0,[friendUID]:0},updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
    }
    chatPanel.classList.add('open'); mainArea.classList.add('with-chat');
    chatPanel.innerHTML=`
      <div class="chat-header"><div><strong>${escapeHtml(friendName)}</strong></div><div><button id="closeChatBtn">‚úñ</button></div></div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input"><input id="chatInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..."><button id="sendMessageBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>
    `;
    document.getElementById('closeChatBtn').onclick=closeChat;

    chatRef.update({[`unreadCounts.${currentUser.uid}`]:0,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});

    if(window._messagesUnsub) window._messagesUnsub();
    window._messagesUnsub=chatRef.collection('messages').orderBy('timestamp').onSnapshot(snapshot=>{
      const msgs=document.getElementById('chatMessages');
      msgs.innerHTML='';
      snapshot.forEach(m=>{
        const msg=m.data();
        const div=document.createElement('div');
        div.className=msg.fromUID===currentUser.uid?'msg-self':'msg-other';
        const time=msg.timestamp?new Date(msg.timestamp.toDate()).toLocaleTimeString():'';
        div.innerHTML=`<div>${escapeHtml(msg.text)}</div><div class="small-muted" style="font-size:11px;margin-top:6px">${time}</div>`;
        msgs.appendChild(div);
      });
      msgs.scrollTop=msgs.scrollHeight;
    });

    document.getElementById('sendMessageBtn').onclick=async ()=>{
      const input=document.getElementById('chatInput');
      const text=input.value.trim();
      if(!text) return;
      const msg={fromUID:currentUser.uid,text:text,timestamp:firebase.firestore.FieldValue.serverTimestamp()};
      await chatRef.collection('messages').add(msg);
      const chatSnapshot=await chatRef.get();
      const members=chatSnapshot.data().members||[];
      const recipient=members.find(u=>u!==currentUser.uid);
      if(recipient) await chatRef.update({[`unreadCounts.${recipient}`]:firebase.firestore.FieldValue.increment(1),updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
      input.value='';
    };
  });
}

function closeChat(){
  if(window._messagesUnsub){window._messagesUnsub(); window._messagesUnsub=null;}
  chatPanel.classList.remove('open'); mainArea.classList.remove('with-chat'); chatPanel.innerHTML='';
}

function listenForMessageCounts(){
  db.collection('chats').where('members','array-contains',currentUser.uid).onSnapshot(snapshot=>{
    let totalUnread=0;
    snapshot.forEach(chat=>{
      const data=chat.data();
      totalUnread += data.unreadCounts[currentUser.uid]||0;
    });
    msgCount.textContent=totalUnread;
  });
}

function updateMessagesList(){
  db.collection('chats').where('members','array-contains',currentUser.uid).get().then(snapshot=>{
    chatsList.innerHTML='';
    snapshot.forEach(chat=>{
      const data = chat.data();
      const otherUID = data.members.find(u=>u!==currentUser.uid);
      db.collection('users').doc(otherUID).get().then(uDoc=>{
        const uData = uDoc.data();
        const div = document.createElement('div');
        div.className='dialog-item';
        div.innerHTML=`<span>${escapeHtml(uData.name)}</span> <span class="unread-badge">${data.unreadCounts[currentUser.uid]||0}</span>`;
        div.onclick=()=>{ openChat(otherUID,uData.name) };
        chatsList.appendChild(div);
      });
    });
  });
}

function updateNotifications(){
  db.collection('users').doc(currentUser.uid).collection('notifications').orderBy('timestamp','desc').get().then(snapshot=>{
    notificationsPanel.innerHTML='<h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>';
    snapshot.forEach(doc=>{
      const n = doc.data();
      const div = document.createElement('div');
      div.className='card';
      div.innerHTML = `<div>${escapeHtml(n.fromName || '–°–∏—Å—Ç–µ–º–∞')} : ${escapeHtml(n.type)}</div>`;
      notificationsPanel.appendChild(div);
    });
    notifCount.textContent = snapshot.size;
  });
}
</script>
</body>
</html>
