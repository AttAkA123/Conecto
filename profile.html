<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Connecto ‚Äî –ü—Ä–æ—Ñ–∏–ª—å –∏ –ù–æ–≤–æ—Å—Ç–∏</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
  html,body{height:100%}
  body{background:linear-gradient(135deg,#3a3a3a,#2a2a2a);color:#fff;height:100vh;overflow:hidden}

  /* layout */
  .container{display:flex;height:100vh;width:100vw}
  .sidebar{width:240px;background:rgba(255,255,255,0.04);backdrop-filter:blur(10px);padding:20px;display:flex;flex-direction:column;gap:14px;flex-shrink:0}
  .center{flex:1;display:flex;flex-direction:column;min-width:0; /* important for flex child shrink */}
  .main{flex:1;background:rgba(255,255,255,0.04);backdrop-filter:blur(8px);margin:20px;border-radius:18px;padding:22px;position:relative;overflow:auto;transition:margin-right .18s ease}
  .chat-panel{width:0;overflow:hidden;transition:width .2s ease;border-left:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column}
  .chat-panel.open{width:380px} /* visible chat width */

  .menu-item{padding:12px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:0.15s}
  .menu-item:hover{background:rgba(255,255,255,0.06)}
  .notif-count{background:#ff4d4d;border-radius:50%;padding:2px 8px;font-size:12px}
  .hidden{display:none}
  input,textarea,button{padding:10px;margin:6px 0;border-radius:10px;border:none;outline:none;font-family:inherit}
  input,textarea{width:100%;background:rgba(255,255,255,0.06);color:#fff}
  textarea{min-height:80px;resize:vertical}
  button{cursor:pointer;background:rgba(255,255,255,0.12);color:#fff}
  button:hover{opacity:0.95}
  .card{background:rgba(255,255,255,0.06);backdrop-filter:blur(4px);border-radius:12px;padding:12px;margin-bottom:12px}
  .card .row{display:flex;align-items:center;justify-content:space-between}
  .card .info{display:flex;align-items:center;gap:10px}
  .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,0.08)}
  .like-btn{padding:6px 10px;border-radius:8px;border:none;background:transparent}
  .like-btn.liked{background:rgba(255,255,255,0.18)}
  .post-create{margin-bottom:14px}
  .btn-primary{background:linear-gradient(90deg,#6ea8fe,#8b5cf6);color:#fff}
  .small-muted{font-size:13px;color:rgba(255,255,255,0.6)}
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .search{width:260px}
  .flex{display:flex;gap:10px;align-items:center}

  /* chat styles (right panel) */
  .chat-header{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02)}
  .chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
  .msg-self{align-self:flex-end;background:rgba(255,255,255,0.9);color:#000;padding:10px;border-radius:12px;max-width:78%}
  .msg-other{align-self:flex-start;background:rgba(255,255,255,0.14);padding:10px;border-radius:12px;max-width:78%}
  .chat-input{display:flex;padding:12px;border-top:1px solid rgba(255,255,255,0.03);gap:8px}
  .chat-input input{flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,0.05);color:#fff}
  .chat-input button{padding:10px 14px;border-radius:10px;background:rgba(255,255,255,0.12);border:none;color:#fff;cursor:pointer}

  /* dialogs list */
  .dialogs-list{display:flex;flex-direction:column;gap:8px}
  .dialog-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(255,255,255,0.03);cursor:pointer}
  .dialog-item:hover{background:rgba(255,255,255,0.06)}
  .unread-badge{background:#ff4747;border-radius:12px;padding:3px 8px;font-size:12px;color:#fff}

  /* responsive: when chat open, reduce main margin so it doesn't get covered visually */
  .main.with-chat{margin-right:400px}
</style>
</head>
<body>
<div class="container">
  <!-- LEFT SIDEBAR -->
  <div class="sidebar">
    <div class="menu-item" id="profileTab">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="menu-item" id="addFriendTab">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</div>
    <div class="menu-item" id="friendsTab">üë• –î—Ä—É–∑—å—è</div>
    <div class="menu-item" id="messagesTab">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è <span id="msgCount" class="notif-count">0</span></div>
    <div class="menu-item" id="newsTab">üì∞ –ù–æ–≤–æ—Å—Ç–∏</div>
    <div class="menu-item" id="notificationsTab">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è <span id="notifCount" class="notif-count">0</span></div>
    <button id="logoutBtn">–í—ã–π—Ç–∏</button>
  </div>

  <!-- CENTER (main content) -->
  <div class="center">
    <div class="main" id="mainArea">
      <div class="topbar">
        <div class="flex">
          <img id="profileAvatarSmall" src="https://via.placeholder.com/48" class="avatar">
          <div>
            <div id="profileName">–ò–º—è</div>
            <div id="profileStatus" class="small-muted">–°—Ç–∞—Ç—É—Å: –ù–µ –æ–Ω–ª–∞–π–Ω</div>
          </div>
        </div>
        <div class="flex">
          <input id="searchInput" class="search" placeholder="–ü–æ–∏—Å–∫...">
          <button id="newPostQuick">–ù–∞–ø–∏—Å–∞—Ç—å</button>
        </div>
      </div>

      <!-- panels -->
      <div id="profilePanel">
        <div style="display:flex;gap:16px;align-items:center;margin-bottom:12px">
          <img id="profileAvatar" src="https://via.placeholder.com/100" style="width:100px;height:100px;border-radius:50%">
          <div>
            <h2 id="profileNameBig">–ò–º—è</h2>
            <p>ID: <span id="profileID">000000</span></p>
            <p>–°—Ç–∞—Ç—É—Å: <span id="profileStatusBig">–ù–µ –æ–Ω–ª–∞–π–Ω</span></p>
            <button id="settingsBtn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          </div>
        </div>
      </div>

      <div id="settingsPanel" class="hidden card">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
        <input type="text" id="newName" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
        <input type="text" id="newAvatar" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä">
        <input type="text" id="newStatus" placeholder="–°—Ç–∞—Ç—É—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: –û–Ω–ª–∞–π–Ω)">
        <button id="saveSettings" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <div id="addFriendPanel" class="hidden card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</h3>
        <input type="number" id="friendID" placeholder="–í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID">
        <button id="searchFriend">–ü–æ–∏—Å–∫</button>
        <div id="friendResult"></div>
      </div>

      <div id="friendsPanel" class="hidden"></div>

      <div id="messagesPanel" class="hidden card">
        <h3>–ß–∞—Ç—ã</h3>
        <div id="chatsList" class="dialogs-list"></div>
      </div>

      <div id="newsPanel" class="hidden">
        <div class="post-create card">
          <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>
          <textarea id="postText" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"></textarea>
          <button id="createPostBtn" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div id="postsFeed"></div>
      </div>

      <div id="notificationsPanel" class="hidden card"></div>
    </div>
  </div>

  <!-- RIGHT CHAT PANEL -->
  <div id="chatPanel" class="chat-panel">
    <!-- content populated by JS -->
  </div>
</div>

<!-- Firebase libs (compat used to match your code style) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
/* =========================
   CONFIG
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDW9wSQ8xVTvrgaDzwYrg1v8Jzm5KqrrAU",
  authDomain: "baseuser-82b5d.firebaseapp.com",
  projectId: "baseuser-82b5d",
  storageBucket: "baseuser-82b5d.appspot.com",
  messagingSenderId: "307488509181",
  appId: "1:307488509181:web:50397c7ba445c6e45a8294"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   ELEMENTS
   ========================= */
const profileTab = document.getElementById('profileTab');
const addFriendTab = document.getElementById('addFriendTab');
const friendsTab = document.getElementById('friendsTab');
const messagesTab = document.getElementById('messagesTab');
const newsTab = document.getElementById('newsTab');
const notificationsTab = document.getElementById('notificationsTab');
const notifCount = document.getElementById('notifCount');
const msgCount = document.getElementById('msgCount');

const profilePanel = document.getElementById('profilePanel');
const settingsPanel = document.getElementById('settingsPanel');
const addFriendPanel = document.getElementById('addFriendPanel');
const friendsPanel = document.getElementById('friendsPanel');
const messagesPanel = document.getElementById('messagesPanel');
const newsPanel = document.getElementById('newsPanel');
const notificationsPanel = document.getElementById('notificationsPanel');

const profileName = document.getElementById('profileName');
const profileNameBig = document.getElementById('profileNameBig');
const profileID = document.getElementById('profileID');
const profileStatus = document.getElementById('profileStatus');
const profileStatusBig = document.getElementById('profileStatusBig');
const profileAvatar = document.getElementById('profileAvatar');
const profileAvatarSmall = document.getElementById('profileAvatarSmall');

const logoutBtn = document.getElementById('logoutBtn');
const friendIDInput = document.getElementById('friendID');
const searchFriendBtn = document.getElementById('searchFriend');
const friendResult = document.getElementById('friendResult');

const createPostBtn = document.getElementById('createPostBtn');
const postText = document.getElementById('postText');
const postsFeed = document.getElementById('postsFeed');

const chatsList = document.getElementById('chatsList');

const chatPanel = document.getElementById('chatPanel');
const mainArea = document.getElementById('mainArea');

let currentChatID = null;
let currentFriendUID = null;
let currentUser = null;

/* =========================
   HELPERS
   ========================= */
function hideAllPanels(){
  profilePanel.classList.add('hidden');
  settingsPanel.classList.add('hidden');
  addFriendPanel.classList.add('hidden');
  friendsPanel.classList.add('hidden');
  messagesPanel.classList.add('hidden');
  newsPanel.classList.add('hidden');
  notificationsPanel.classList.add('hidden');
}

function escapeHtml(str){
  if(!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* =========================
   TABS
   ========================= */
profileTab.addEventListener('click', ()=>{ hideAllPanels(); profilePanel.classList.remove('hidden'); });
addFriendTab.addEventListener('click', ()=>{ hideAllPanels(); addFriendPanel.classList.remove('hidden'); });
friendsTab.addEventListener('click', ()=>{ hideAllPanels(); friendsPanel.classList.remove('hidden'); updateFriendsList(); });
messagesTab.addEventListener('click', ()=>{ hideAllPanels(); messagesPanel.classList.remove('hidden'); updateMessagesList(); /* do not auto-open chat */ });
newsTab.addEventListener('click', ()=>{ hideAllPanels(); newsPanel.classList.remove('hidden'); });
notificationsTab.addEventListener('click', ()=>{ hideAllPanels(); notificationsPanel.classList.remove('hidden'); updateNotifications(); });

/* =========================
   AUTH & PROFILE
   ========================= */
async function loadProfile(){
  const user = auth.currentUser;
  if(!user) return;
  currentUser = user;
  const doc = await db.collection('users').doc(user.uid).get();
  if(!doc.exists) {
    // If user doc missing, create minimal doc
    await db.collection('users').doc(user.uid).set({
      name: user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
      customID: Math.floor(100000 + Math.random()*899999),
      avatar: user.photoURL || null,
      status: '–û–Ω–ª–∞–π–Ω',
      friends: []
    }, {merge:true});
    // reload
    return loadProfile();
  }
  const data = doc.data();
  profileName.textContent = data.name || user.displayName || '–ò–º—è';
  profileNameBig.textContent = data.name || user.displayName || '–ò–º—è';
  profileID.textContent = data.customID || '000000';
  profileStatus.textContent = data.status || '–ù–µ –æ–Ω–ª–∞–π–Ω';
  profileStatusBig.textContent = data.status || '–ù–µ –æ–Ω–ª–∞–π–Ω';
  profileAvatar.src = data.avatar || 'https://via.placeholder.com/100';
  profileAvatarSmall.src = data.avatar || 'https://via.placeholder.com/48';
}

/* redirect to login if not auth */
auth.onAuthStateChanged(async (user)=>{
  if(!user){ window.location.href = 'index.html'; return; }
  currentUser = user;
  await loadProfile();
  listenForPosts();
  listenForMessageCounts();
  // show default panel
  hideAllPanels();
  profilePanel.classList.remove('hidden');
});

/* logout */
logoutBtn.onclick = ()=>{ auth.signOut().then(()=>{ window.location.href='index.html'; }); }

/* =========================
   SETTINGS
   ========================= */
const settingsBtn = document.getElementById('settingsBtn');
const newName = document.getElementById('newName');
const newAvatar = document.getElementById('newAvatar');
const newStatus = document.getElementById('newStatus');
const saveSettings = document.getElementById('saveSettings');

settingsBtn.onclick = ()=>{ hideAllPanels(); settingsPanel.classList.remove('hidden'); };
saveSettings.onclick = async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  let updates = {};
  if(newName.value.trim()) updates.name = newName.value.trim();
  if(newAvatar.value.trim()) updates.avatar = newAvatar.value.trim();
  if(newStatus.value.trim()) updates.status = newStatus.value.trim();
  if(Object.keys(updates).length===0) return alert('–ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å');
  await db.collection('users').doc(user.uid).update(updates);
  await loadProfile();
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
};

/* =========================
   FRIENDS
   ========================= */
searchFriendBtn.onclick = async ()=>{
  const id = Number(friendIDInput.value.trim());
  if(!id) return;
  const q = await db.collection('users').where('customID','==',id).get();
  if(q.empty){ friendResult.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</p>'; return; }
  const friendDoc = q.docs[0];
  const friendData = friendDoc.data();
  friendResult.innerHTML = `<p>${friendData.name} (ID:${friendData.customID})</p><button id="sendRequest">–î–æ–±–∞–≤–∏—Ç—å</button>`;
  document.getElementById('sendRequest').onclick = async ()=>{
    const user = auth.currentUser;
    await db.collection('users').doc(friendDoc.id).collection('notifications').add({
      type:'friend_request', fromUID:user.uid, fromName: user.displayName || user.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', timestamp: firebase.firestore.FieldValue.serverTimestamp(), status:'pending'
    });
    friendResult.innerHTML = '<p>–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</p>';
    updateNotifications();
  };
};

async function updateFriendsList(){
  const user = auth.currentUser;
  const doc = await db.collection('users').doc(user.uid).get();
  const friendsUIDs = (doc.exists && doc.data().friends) ? doc.data().friends : [];
  friendsPanel.innerHTML = '<h3>–î—Ä—É–∑—å—è</h3>';
  for(const uid of friendsUIDs){
    const fdoc = await db.collection('users').doc(uid).get();
    const fdata = fdoc.exists ? fdoc.data() : { name:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π', avatar:null, customID:'----' };
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<div class="row"><div class="info"><img src="${fdata.avatar || 'https://via.placeholder.com/40'}" class="avatar"><div><strong>${fdata.name}</strong><div class="small-muted">ID: ${fdata.customID}</div></div></div><div class="flex"><button class="writeBtn">–ù–∞–ø–∏—Å–∞—Ç—å</button><button class="deleteBtn">–£–¥–∞–ª–∏—Ç—å</button></div></div>`;
    friendsPanel.appendChild(div);
    div.querySelector('.writeBtn').onclick = ()=> openChat(uid, fdata.name);
    div.querySelector('.deleteBtn').onclick = async ()=>{
      await db.collection('users').doc(user.uid).update({ friends: firebase.firestore.FieldValue.arrayRemove(uid) });
      await db.collection('users').doc(uid).update({ friends: firebase.firestore.FieldValue.arrayRemove(user.uid) });
      updateFriendsList();
    };
  }
}

/* =========================
   NOTIFICATIONS
   ========================= */
async function updateNotifications(){
  const user = auth.currentUser; if(!user) return;
  const notifSnap = await db.collection('users').doc(user.uid).collection('notifications').where('status','==','pending').get();
  notifCount.textContent = notifSnap.size;
  notificationsPanel.innerHTML = '';
  notifSnap.forEach(doc=>{
    const n = doc.data();
    const div = document.createElement('div'); div.className='card';
    if(n.type === 'friend_request'){
      div.innerHTML = `<p>${n.fromName} —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è</p><div style="display:flex;gap:8px"><button id="accept${doc.id}">–ü—Ä–∏–Ω—è—Ç—å</button><button id="reject${doc.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button></div>`;
      notificationsPanel.appendChild(div);
      document.getElementById(`accept${doc.id}`).onclick = async ()=>{
        await db.collection('users').doc(user.uid).update({ friends: firebase.firestore.FieldValue.arrayUnion(n.fromUID) });
        await db.collection('users').doc(n.fromUID).update({ friends: firebase.firestore.FieldValue.arrayUnion(user.uid) });
        await db.collection('users').doc(user.uid).collection('notifications').doc(doc.id).update({ status:'accepted' });
        div.remove(); updateFriendsList();
      };
      document.getElementById(`reject${doc.id}`).onclick = async ()=>{
        await db.collection('users').doc(user.uid).collection('notifications').doc(doc.id).update({ status:'rejected' });
        div.remove();
      };
    }
  });
}

/* =========================
   POSTS (–ù–û–í–û–°–¢–ò)
   ========================= */
createPostBtn.onclick = async ()=>{
  const text = postText.value.trim();
  if(!text) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
  const user = auth.currentUser;
  const uDoc = await db.collection('users').doc(user.uid).get();
  const u = uDoc.exists ? uDoc.data() : { name: user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', avatar: null };
  await db.collection('posts').add({
    authorUID: user.uid,
    authorName: u.name || user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
    authorAvatar: u.avatar || null,
    text: text,
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  postText.value = '';
};

let postsUnsubscribe = null;
function listenForPosts(){
  if(postsUnsubscribe) postsUnsubscribe();
  postsUnsubscribe = db.collection('posts').orderBy('timestamp','desc')
    .onSnapshot(snapshot=>{
      postsFeed.innerHTML = '';
      snapshot.forEach(doc=>{
        const p = doc.data();
        const id = doc.id;
        const card = document.createElement('div'); card.className='card';
        const liked = (p.likes || []).includes(currentUser.uid);
        card.innerHTML = `
          <div class="row">
            <div class="info"><img src="${p.authorAvatar || 'https://via.placeholder.com/48'}" class="avatar"><div><strong>${p.authorName}</strong><div class="small-muted">${p.timestamp? new Date(p.timestamp.toDate()).toLocaleString() : ''}</div></div></div>
            <div class="flex"><button class="like-btn ${liked? 'liked':''}" data-id="${id}">‚ù§Ô∏è ${ (p.likes||[]).length }</button></div>
          </div>
          <div style="margin-top:8px">${escapeHtml(p.text)}</div>
        `;
        postsFeed.appendChild(card);
        const likeBtn = card.querySelector('.like-btn');
        likeBtn.onclick = async ()=>{
          const uid = currentUser.uid;
          const postRef = db.collection('posts').doc(id);
          await db.runTransaction(async tx=>{
            const snap = await tx.get(postRef);
            const data = snap.data() || {likes:[]};
            const likes = data.likes || [];
            if(likes.includes(uid)){
              tx.update(postRef, { likes: firebase.firestore.FieldValue.arrayRemove(uid) });
            } else {
              tx.update(postRef, { likes: firebase.firestore.FieldValue.arrayUnion(uid) });
            }
          });
        };
      });
    });
}

/* =========================
   CHATS & DIALOGS
   ========================= */

/*
  Chat doc structure:
  chats (collection)
    - <chatId> (doc)
        members: [uid1, uid2]
        unreadCounts: { <uid1>: number, <uid2>: number }
        updatedAt: timestamp
    - messages (subcollection) -> timestamped message docs

  chatId is deterministic: sorted uids joined by '_'
*/

let chatsUnsub = null;
function updateMessagesList(){
  // listen in real-time to all chats that include current user and update dialogs list
  if(chatsUnsub) chatsUnsub();
  chatsUnsub = db.collection('chats').where('members','array-contains', currentUser.uid)
    .onSnapshot(async snapshot=>{
      chatsList.innerHTML = '';
      // fetch user info for each chat's other member
      const docs = snapshot.docs.sort((a,b)=>{
        const da = a.data().updatedAt ? a.data().updatedAt.toMillis() : 0;
        const dbt = b.data().updatedAt ? b.data().updatedAt.toMillis() : 0;
        return dbt - da; // newest first
      });
      for(const docSnap of docs){
        const chat = docSnap.data();
        const chatId = docSnap.id;
        const otherUID = chat.members.find(u=>u!==currentUser.uid);
        // try to get user info
        const udoc = await db.collection('users').doc(otherUID).get();
        const udata = udoc.exists ? udoc.data() : { name: otherUID, avatar: null, customID:'----' };
        const unread = (chat.unreadCounts && chat.unreadCounts[currentUser.uid]) ? chat.unreadCounts[currentUser.uid] : 0;
        const item = document.createElement('div');
        item.className = 'dialog-item';
        item.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><img src="${udata.avatar||'https://via.placeholder.com/40'}" class="avatar" style="width:40px;height:40px"><div><strong>${udata.name}</strong><div class="small-muted">ID: ${udata.customID||'‚Äî'}</div></div></div><div style="display:flex;align-items:center;gap:8px">${unread>0?`<span class="unread-badge">${unread}</span>`:''}<button class="openChatBtn">–û—Ç–∫—Ä—ã—Ç—å</button></div>`;
        chatsList.appendChild(item);
        item.querySelector('.openChatBtn').onclick = ()=> openChat(otherUID, udata.name);
      }
    });
}

async function openChat(friendUID, friendName){
  // Open right chat panel and populate messages.
  // Create chat doc if not exists.
  currentFriendUID = friendUID;
  const user = auth.currentUser;
  currentChatID = [user.uid, friendUID].sort().join('_');
  const chatRef = db.collection('chats').doc(currentChatID);
  const chatDoc = await chatRef.get();
  if(!chatDoc.exists){
    await chatRef.set({
      members:[user.uid, friendUID],
      unreadCounts: { [user.uid]: 0, [friendUID]: 0 },
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
  // make chat panel visible
  chatPanel.classList.add('open');
  mainArea.classList.add('with-chat');

  // build chat panel content
  chatPanel.innerHTML = `
    <div class="chat-header">
      <div>
        <strong id="chatWithName">${escapeHtml(friendName)}</strong>
        <div class="small-muted" id="chatWithStatus"> </div>
      </div>
      <div>
        <button id="closeChatBtn" title="–ó–∞–∫—Ä—ã—Ç—å">‚úñ</button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
      <button id="sendMessageBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  `;

  // close handler (works reliably)
  document.getElementById('closeChatBtn').onclick = closeChat;

  // mark unread for current user as 0
  await chatRef.update({ [`unreadCounts.${user.uid}`]: 0, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });

  // listen messages realtime
  if(window._messagesUnsub) window._messagesUnsub(); // remove previous
  window._messagesUnsub = chatRef.collection('messages').orderBy('timestamp')
    .onSnapshot(snapshot=>{
      const msgs = document.getElementById('chatMessages');
      msgs.innerHTML = '';
      snapshot.forEach(mdoc=>{
        const m = mdoc.data();
        const div = document.createElement('div');
        div.className = m.fromUID === user.uid ? 'msg-self' : 'msg-other';
        const time = m.timestamp ? new Date(m.timestamp.toDate()).toLocaleTimeString() : '';
        div.innerHTML = `<div>${escapeHtml(m.text)}</div><div class="small-muted" style="font-size:11px;margin-top:6px">${time}</div>`;
        msgs.appendChild(div);
      });
      msgs.scrollTop = msgs.scrollHeight;
    });

  // send message handler
  document.getElementById('sendMessageBtn').onclick = async ()=>{
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if(!text) return;
    const msg = { fromUID: user.uid, text: text, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
    await chatRef.collection('messages').add(msg);
    // increment unread for recipient
    const chatSnapshot = await chatRef.get();
    if(chatSnapshot.exists){
      const members = chatSnapshot.data().members || [];
      const recipient = members.find(u=>u!==user.uid);
      if(recipient){
        await chatRef.update({ [`unreadCounts.${recipient}`]: firebase.firestore.FieldValue.increment(1), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }
    input.value = '';
  };

  // optional: show friend's status if available
  const uDoc = await db.collection('users').doc(friendUID).get();
  if(uDoc.exists){
    const ud = uDoc.data();
    const statusEl = document.getElementById('chatWithStatus');
    if(statusEl) statusEl.textContent = ud.status ? `–°—Ç–∞—Ç—É—Å: ${ud.status}` : '';
  }
}

function closeChat(){
  if(window._messagesUnsub) { window._messagesUnsub(); window._messagesUnsub = null; }
  chatPanel.classList.remove('open');
  mainArea.classList.remove('with-chat');
  chatPanel.innerHTML = ''; // clear content
  currentChatID = null;
  currentFriendUID = null;
  // update message counts in sidebar if needed
  listenForMessageCounts(); // refresh count
}

/* =========================
   Listen unread totals & dialogs
   ========================= */
let unreadUnsub = null;
function listenForMessageCounts(){
  if(unreadUnsub) unreadUnsub();
  unreadUnsub = db.collection('chats').where('members','array-contains', currentUser.uid)
    .onSnapshot(snapshot=>{
      let total = 0;
      snapshot.forEach(doc=>{
        const d = doc.data();
        const uc = d.unreadCounts || {};
        total += (uc[currentUser.uid] || 0);
      });
      msgCount.textContent = total;
    });
}

/* =========================
   listen messages list (dialogs)
   ========================= */
function listenDialogsRealtime(){
  // we call updateMessagesList which uses onSnapshot internally; nothing else needed here
  updateMessagesList();
}

/* =========================
   listen posts on auth
   ========================= */
function listenForPosts(){
  // implement earlier function to listen and render posts
  // already defined above as listenForPosts (just call it)
  if(typeof listenForPosts === 'function') {
    // if the function exists above we already used that name; but to be safe call posts listener directly:
  }
  // call the posts listener we defined earlier (it exists because function declared above)
}

/* =========================
   Start listeners after auth
   ========================= */
auth.onAuthStateChanged(user=>{
  if(!user) return;
  currentUser = user;
  // start listening posts & dialogs & unread counts
  listenForPosts(); // defined above
  listenForMessageCounts();
  listenDialogsRealtime();
});

/* =========================
   INITIAL: keep main panel visible
   ========================= */

/* Note: updateMessagesList() uses onSnapshot to keep dialogs up-to-date.
   openChat() creates chat doc if needed and opens right-side panel. 
   closeChat() reliably closes it (handler is attached inside openChat).
*/

</script>
</body>
</html>
