<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connecto ‚Äî –°–æ—Ü—Å–µ—Ç—å</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",sans-serif;}
body{background:#2f2f2f;color:#fff;height:100vh;overflow:hidden;}
.auth-container{display:flex;align-items:center;justify-content:center;height:100vh;transition:opacity 0.5s;}
.container{background:rgba(255,255,255,0.05);border-radius:20px;padding:40px;width:360px;text-align:center;backdrop-filter:blur(10px);box-shadow:0 0 30px rgba(0,0,0,0.5);}
input{width:90%;padding:12px;margin:10px 0;border:none;border-radius:10px;background:rgba(255,255,255,0.1);color:#fff;}
input::placeholder{color:#ccc;}
button{width:90%;padding:12px;margin-top:10px;border:none;border-radius:10px;font-weight:bold;color:#2f2f2f;background:#fff;cursor:pointer;transition:0.3s;}
button:hover{background:#dcdcdc;}
.hidden{display:none;}
.main-page{display:flex;height:100vh;overflow:hidden;}
.sidebar{width:250px;background:rgba(255,255,255,0.05);padding:20px;display:flex;flex-direction:column;align-items:center;backdrop-filter:blur(10px);box-shadow:0 0 30px rgba(0,0,0,0.5);}
.sidebar img{width:80px;height:80px;border-radius:50%;border:3px solid white;margin-bottom:10px;object-fit:cover;}
.sidebar h3,p{margin:5px 0;text-align:center;}
.sidebar button{width:100%;margin-top:15px;}
.content{flex:1;padding:30px;overflow-y:auto;}
.tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.tab{background: rgba(255,255,255,0.1);border-radius:10px;padding:10px 20px;cursor:pointer;transition:0.3s;}
.tab.active,.tab:hover{background: rgba(255,255,255,0.2);}
.tab-content{background: rgba(255,255,255,0.05);border-radius:20px;padding:20px;min-height:400px;box-shadow:0 0 15px rgba(0,0,0,0.3);}
#searchResults div,#friendsList div,#notificationsList div,#chatList div{display:flex;align-items:center;margin-top:10px;background: rgba(255,255,255,0.05);padding:10px;border-radius:10px;}
#searchResults img,#friendsList img,#notificationsList img,#chatList img{width:50px;height:50px;border-radius:50%;margin-right:10px;object-fit:cover;}
#searchResults button,#friendsList button,#notificationsList button,#chatList button{margin-left:auto;}
.onlineDot{width:12px;height:12px;border-radius:50%;background:lime;margin-right:5px;}
.chatBox{display:flex;flex-direction:column;gap:10px;margin-top:10px;max-height:400px;overflow-y:auto;}
.chatMessage{background:rgba(255,255,255,0.1);padding:10px;border-radius:10px;}
.chatMessage.self{background:rgba(0,200,0,0.2);}
.chatInput{display:flex;gap:10px;margin-top:10px;}
.chatInput input{flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.1);color:#fff;}
.chatInput input::placeholder{color:#ccc;}
</style>
</head>
<body>

<!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
<div id="authContainer" class="auth-container">
  <div class="container">
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Connecto</h1>
    <div id="buttons">
      <button id="btnRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      <button id="btnLogin">–í–æ–π—Ç–∏</button>
    </div>
    <div id="registerForm" class="hidden">
      <input type="text" id="regName" placeholder="–ò–º—è">
      <input type="email" id="regEmail" placeholder="–ü–æ—á—Ç–∞">
      <input type="password" id="regPass" placeholder="–ü–∞—Ä–æ–ª—å">
      <button id="createAccountBtn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
      <button onclick="goBack()">–ù–∞–∑–∞–¥</button>
    </div>
    <div id="loginForm" class="hidden">
      <input type="email" id="loginEmail" placeholder="–ü–æ—á—Ç–∞">
      <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
      <button id="loginBtn">–í–æ–π—Ç–∏</button>
      <button onclick="goBack()">–ù–∞–∑–∞–¥</button>
    </div>
  </div>
</div>

<!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
<div id="mainPage" class="hidden main-page">
  <div class="sidebar">
    <img id="userPhoto" src="https://via.placeholder.com/80" alt="–§–æ—Ç–æ">
    <h3 id="userName"></h3>
    <p>ID: <span id="userUniqueId"></span></p>
    <p id="userEmail"></p>
    <div style="display:flex;align-items:center"><div class="onlineDot" id="onlineDot"></div><span>Online</span></div>
    <button onclick="openSettings()">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
  </div>
  <div class="content">
    <div class="tabs">
      <div class="tab active" onclick="showTab('news',event)">–ù–æ–≤–æ—Å—Ç–∏</div>
      <div class="tab" onclick="showTab('addFriend',event)">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</div>
      <div class="tab" onclick="showTab('friends',event)">–î—Ä—É–∑—å—è</div>
      <div class="tab" onclick="showTab('notifications',event)">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
      <div class="tab" onclick="showTab('messages',event)">–°–æ–æ–±—â–µ–Ω–∏—è</div>
    </div>
    <div id="tabContent" class="tab-content"></div>
  </div>
</div>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<div id="settings" class="hidden auth-container">
  <div class="container">
    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
    <input type="text" id="newName" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
    <input type="file" id="newPhoto" accept="image/*">
    <button onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeSettings()">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<script type="module">
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, setDoc, doc, getDoc, updateDoc, collection, query, where, getDocs, arrayUnion, arrayRemove, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDW9wSQ8xVTvrgaDzwYrg1v8Jzm5KqrrAU",
  authDomain: "baseuser-82b5d.firebaseapp.com",
  projectId: "baseuser-82b5d",
  storageBucket: "baseuser-82b5d.appspot.com",
  messagingSenderId: "307488509181",
  appId: "1:307488509181:web:50397c7ba445c6e45a8294"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// –≠–ª–µ–º–µ–Ω—Ç—ã
const buttons=document.getElementById("buttons");
const registerForm=document.getElementById("registerForm");
const loginForm=document.getElementById("loginForm");
const mainPage=document.getElementById("mainPage");
const settingsPage=document.getElementById("settings");
const onlineDot=document.getElementById("onlineDot");

let currentUserId=null;
let currentUserData=null;
let currentChatId=null;

// --- UI ---
document.getElementById("btnRegister").onclick=()=>{buttons.classList.add("hidden");registerForm.classList.remove("hidden");};
document.getElementById("btnLogin").onclick=()=>{buttons.classList.add("hidden");loginForm.classList.remove("hidden");};
window.goBack=()=>{registerForm.classList.add("hidden");loginForm.classList.add("hidden");buttons.classList.remove("hidden");};

// --- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ---
document.getElementById("createAccountBtn").onclick=async()=>{
  const name=document.getElementById("regName").value.trim();
  const email=document.getElementById("regEmail").value.trim();
  const password=document.getElementById("regPass").value.trim();
  if(!name||!email||!password) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
  try{
    const userCred=await createUserWithEmailAndPassword(auth,email,password);
    const uniqueId=Math.floor(100000+Math.random()*900000);
    await setDoc(doc(db,"users",userCred.user.uid),{
      name,email,photo:"https://via.placeholder.com/80",uniqueId,friends:[],friendRequests:[],online:true
    });
    alert(`–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í–∞—à ID: ${uniqueId}`);
    goBack();
  }catch(err){alert(err.message);}
};

// --- –í—Ö–æ–¥ ---
document.getElementById("loginBtn").onclick=async()=>{
  const email=document.getElementById("loginEmail").value.trim();
  const password=document.getElementById("loginPass").value.trim();
  if(!email||!password) return alert("–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç—É –∏ –ø–∞—Ä–æ–ª—å!");
  try{
    const userCred=await signInWithEmailAndPassword(auth,email,password);
    currentUserId=userCred.user.uid;
    const userRef=doc(db,"users",currentUserId);
    await updateDoc(userRef,{online:true});
    currentUserData=(await getDoc(userRef)).data();
    loadMainPage();
  }catch(err){alert(err.message);}
};

// --- Logout ---
window.logout=async()=>{
  if(currentUserId) await updateDoc(doc(db,"users",currentUserId),{online:false});
  await signOut(auth);
  mainPage.classList.add("hidden");
  document.getElementById("authContainer").classList.remove("hidden");
};

// --- –ê–≤—Ç–æ –≤—Ö–æ–¥ ---
onAuthStateChanged(auth,async user=>{
  if(user){
    currentUserId=user.uid;
    const userRef=doc(db,"users",currentUserId);
    await updateDoc(userRef,{online:true});
    currentUserData=(await getDoc(userRef)).data();
    loadMainPage();
  }
});

// --- –ì–ª–∞–≤–Ω–∞—è ---
function loadMainPage(){
  document.getElementById("authContainer").classList.add("hidden");
  mainPage.classList.remove("hidden");
  document.getElementById("userName").textContent=currentUserData.name;
  document.getElementById("userEmail").textContent=currentUserData.email;
  document.getElementById("userUniqueId").textContent=currentUserData.uniqueId;
  document.getElementById("userPhoto").src=currentUserData.photo;
  onlineDot.style.background=currentUserData.online?"lime":"red";
  showTab("news");
}

// --- Tabs ---
window.showTab=(tab,event)=>{
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  if(event) event.target.classList.add("active");
  const content=document.getElementById("tabContent");
  content.innerHTML="";
  if(tab=="news"){content.innerHTML="<h2>–ù–æ–≤–æ—Å—Ç–∏</h2><p>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è!</p>";}
  else if(tab=="addFriend"){renderAddFriend();}
  else if(tab=="friends"){renderFriends();}
  else if(tab=="notifications"){renderNotifications();}
  else if(tab=="messages"){renderChats();}
};

// --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
window.openSettings=()=>{settingsPage.classList.remove("hidden");mainPage.classList.add("hidden");};
window.closeSettings=()=>{settingsPage.classList.add("hidden");mainPage.classList.remove("hidden");};
window.saveSettings=async()=>{
  const newName=document.getElementById("newName").value.trim();
  const newPhoto=document.getElementById("newPhoto").files[0];
  const updates={};
  if(newName) updates.name=newName;
  if(newPhoto){
    const photoRef=ref(storage,`users/${currentUserId}/avatar.jpg`);
    await uploadBytes(photoRef,newPhoto);
    updates.photo=await getDownloadURL(photoRef);
  }
  await updateDoc(doc(db,"users",currentUserId),updates);
  currentUserData=(await getDoc(doc(db,"users",currentUserId))).data();
  document.getElementById("userName").textContent=currentUserData.name;
  document.getElementById("userPhoto").src=currentUserData.photo;
  closeSettings();
};

// --- –î—Ä—É–∑—å—è, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á–∞—Ç ---
async function renderAddFriend(){
  const content=document.getElementById("tabContent");
  content.innerHTML=`<h2>–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</h2>
    <input type="number" id="searchId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞">
    <button id="searchBtn">–ü–æ–∏—Å–∫</button>
    <div id="searchResults"></div>`;
  document.getElementById("searchBtn").onclick=async()=>{
    const searchId=parseInt(document.getElementById("searchId").value);
    if(!searchId) return;
    const q=query(collection(db,"users"),where("uniqueId","==",searchId));
    const snap=await getDocs(q);
    const results=document.getElementById("searchResults");
    results.innerHTML="";
    snap.forEach(docSnap=>{
      if(docSnap.id===currentUserId) return;
      const user=docSnap.data();
      const div=document.createElement("div");
      div.innerHTML=`<img src="${user.photo}"><div>${user.name} (ID:${user.uniqueId})</div>`;
      const addBtn=document.createElement("button");
      addBtn.textContent="–î–æ–±–∞–≤–∏—Ç—å";
      addBtn.onclick=async()=>{
        await updateDoc(doc(db,"users",docSnap.id),{friendRequests:arrayUnion(currentUserId)});
        alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!");
      };
      div.appendChild(addBtn);
      results.appendChild(div);
    });
  };
}

async function renderFriends(){
  const content=document.getElementById("tabContent");
  content.innerHTML=`<h2>–î—Ä—É–∑—å—è</h2><div id="friendsList"></div>`;
  const friendsList=document.getElementById("friendsList");
  const userDoc=await getDoc(doc(db,"users",currentUserId));
  friendsList.innerHTML="";
  for(const fid of userDoc.data().friends){
    const f=await getDoc(doc(db,"users",fid));
    const u=f.data();
    const div=document.createElement("div");
    div.innerHTML=`<img src="${u.photo}"><div>${u.name} <span style="color:${u.online?'lime':'gray'}">‚óè</span></div>`;
    const msgBtn=document.createElement("button");
    msgBtn.textContent="–ù–∞–ø–∏—Å–∞—Ç—å";
    msgBtn.onclick=()=>openChat(fid,u.name,u.photo);
    const delBtn=document.createElement("button");
    delBtn.textContent="–£–¥–∞–ª–∏—Ç—å";
    delBtn.onclick=async()=>{
      await updateDoc(doc(db,"users",currentUserId),{friends:arrayRemove(fid)});
      await updateDoc(doc(db,"users",fid),{friends:arrayRemove(currentUserId)});
      renderFriends();
    };
    div.appendChild(msgBtn);div.appendChild(delBtn);
    friendsList.appendChild(div);
  }
}

async function renderNotifications(){
  const content=document.getElementById("tabContent");
  content.innerHTML=`<h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2><div id="notificationsList"></div>`;
  const notifList=document.getElementById("notificationsList");
  const userDoc=await getDoc(doc(db,"users",currentUserId));
  notifList.innerHTML="";
  for(const reqId of userDoc.data().friendRequests){
    const u=await getDoc(doc(db,"users",reqId));
    const user=u.data();
    const div=document.createElement("div");
    div.innerHTML=`<img src="${user.photo}"><div>${user.name} —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å</div>`;
    const accept=document.createElement("button");
    accept.textContent="–ü—Ä–∏–Ω—è—Ç—å";
    accept.onclick=async()=>{
      await updateDoc(doc(db,"users",currentUserId),{friends:arrayUnion(reqId),friendRequests:arrayRemove(reqId)});
      await updateDoc(doc(db,"users",reqId),{friends:arrayUnion(currentUserId)});
      renderNotifications();renderFriends();
    };
    const reject=document.createElement("button");
    reject.textContent="–û—Ç–∫–ª–æ–Ω–∏—Ç—å";
    reject.onclick=async()=>{
      await updateDoc(doc(db,"users",currentUserId),{friendRequests:arrayRemove(reqId)});
      renderNotifications();
    };
    div.appendChild(accept);div.appendChild(reject);
    notifList.appendChild(div);
  }
}

async function renderChats(){
  const content=document.getElementById("tabContent");
  content.innerHTML=`<h2>–°–æ–æ–±—â–µ–Ω–∏—è</h2><div id="chatList"></div>`;
  const chatList=document.getElementById("chatList");
  const userDoc=await getDoc(doc(db,"users",currentUserId));
  chatList.innerHTML="";
  for(const fid of userDoc.data().friends){
    const f=await getDoc(doc(db,"users",fid));
    const u=f.data();
    const div=document.createElement("div");
    div.innerHTML=`<img src="${u.photo}"><div>${u.name}</div>`;
    const open=document.createElement("button");
    open.textContent="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç";
    open.onclick=()=>openChat(fid,u.name,u.photo);
    div.appendChild(open);
    chatList.appendChild(div);
  }
}

window.openChat=async(fid,name,photo)=>{
  const content=document.getElementById("tabContent");
  content.innerHTML=`<h2>–ß–∞—Ç —Å ${name}</h2>
  <div id="chatBox" class="chatBox"></div>
  <div class="chatInput">
    <input type="text" id="chatMsg" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
    <button id="sendMsgBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>`;
  const chatBox=document.getElementById("chatBox");
  currentChatId=[currentUserId,fid].sort().join("_");
  const chatRef=collection(db,"chats",currentChatId,"messages");
  onSnapshot(query(chatRef,orderBy("timestamp")),snap=>{
    chatBox.innerHTML="";
    snap.forEach(docSnap=>{
      const m=docSnap.data();
      const div=document.createElement("div");
      div.className="chatMessage"+(m.from===currentUserId?" self":"");
      div.textContent=m.text;
      chatBox.appendChild(div);
      chatBox.scrollTop=chatBox.scrollHeight;
    });
  });
  document.getElementById("sendMsgBtn").onclick=async()=>{
    const msg=document.getElementById("chatMsg").value.trim();
    if(!msg) return;
    await setDoc(doc(chatRef),{text:msg,from:currentUserId,timestamp:serverTimestamp()});
    document.getElementById("chatMsg").value="";
  };
};
</script>
</body>
</html>
